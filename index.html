<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>استبيان الاكتئاب (PHQ-8)</title>
  <style>
    body {
      font-family: "Tahoma", sans-serif;
      background: #f4f6f9;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    form {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 18px;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
      text-align: right;
    }
    input, select {
      padding: 10px;
      width: 95%;
      font-size: 16px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .question {
      margin: 20px 0;
      text-align: right;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    .question p {
      font-size: 18px;
      margin-bottom: 10px;
      font-weight: bold;
      color: #444;
    }
    .question label {
      font-weight: normal;
      margin-left: 15px;
      display: inline-block;
      padding: 8px 15px;
      background: #f8f9fa;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .question label:hover {
      background: #e9ecef;
    }
    .question input[type="radio"] {
      width: auto;
      margin-left: 5px;
    }
    button {
      padding: 12px 25px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
    }
    #recordBtn { 
      background: #007bff; 
      color: white; 
    }
    #recordBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #stopBtn { 
      background: #dc3545; 
      color: white; 
    }
    #stopBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #submitBtn { 
      background: #28a745; 
      color: white; 
      width: 100%;
      padding: 15px;
      font-size: 20px;
      margin-top: 20px;
    }
    #submitBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #recordStatus {
      font-size: 16px;
      margin: 15px 0;
      color: #666;
    }
    #progressBar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    #progressFill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #28a745);
      width: 0%;
      transition: width 0.3s;
    }
    .file-info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border-right: 4px solid #007bff;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <h1>📝 استبيان الاكتئاب (PHQ-8)</h1>

  <form id="surveyForm">
    <label>العمر:</label>
    <input type="number" id="age" name="age" required min="18" max="100">

    <label>النوع:</label>
    <select id="gender" name="gender" required>
      <option value="">اختر</option>
      <option value="male">ذكر</option>
      <option value="female">أنثى</option>
      <option value="other">آخر</option>
    </select>

    <!-- أسئلة PHQ-8 (بدون السؤال التاسع) -->
    <div id="questions"></div>

    <!-- تسجيل الصوت -->
    <h2>🎤 التسجيل الصوتي (اختياري)</h2>
    <button type="button" id="recordBtn">ابدأ التسجيل</button>
    <button type="button" id="stopBtn" disabled>إيقاف التسجيل</button>
    <p id="recordStatus">لم يبدأ التسجيل بعد</p>
    
    <!-- شريط التقدم -->
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
    <div id="fileInfo" class="file-info"></div>

    <button type="submit" id="submitBtn">إرسال الاستبيان</button>
  </form>

  <script>
    // أسئلة PHQ-8 فقط (بدون السؤال التاسع عن الموت)
    const questionsText = [
      "قلة الاهتمام أو المتعة بالقيام بالأشياء",
      "الشعور بالإحباط أو الاكتئاب أو اليأس",
      "صعوبة النوم أو النوم لفترات طويلة",
      "الشعور بالتعب أو فقدان الطاقة",
      "ضعف الشهية أو الإفراط في الأكل",
      "الشعور السيء تجاه نفسك أو أنك فاشل",
      "صعوبة التركيز في الأنشطة اليومية",
      "الحركة أو الكلام ببطء شديد أو بسرعة مفرطة"
      // تم حذف السؤال التاسع عن الموت وإيذاء النفس
    ];

    const questionsDiv = document.getElementById("questions");
    questionsText.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="q${i}" value="0" required> أبداً (0 يوم)</label>
        <label><input type="radio" name="q${i}" value="1"> عدة أيام (1-7 أيام)</label>
        <label><input type="radio" name="q${i}" value="2"> أكثر من نصف الأيام</label>
        <label><input type="radio" name="q${i}" value="3"> تقريباً كل يوم</label>
      `;
      questionsDiv.appendChild(div);
    });

    // تسجيل الصوت
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let recordingStartTime;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordStatus = document.getElementById("recordStatus");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const fileInfo = document.getElementById("fileInfo");
    const submitBtn = document.getElementById("submitBtn");

    recordBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true
          } 
        });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recordingStartTime = Date.now();

        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const duration = Math.round((Date.now() - recordingStartTime) / 1000);
          const sizeMB = (audioBlob.size / (1024 * 1024)).toFixed(2);
          
          recordStatus.textContent = `✅ تم تسجيل ${duration} ثانية (${sizeMB} MB)`;
          fileInfo.textContent = `حجم الملف: ${sizeMB} MB - المدة: ${duration} ثانية`;
          
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordStatus.textContent = "🔴 جاري التسجيل...";
        recordBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (error) {
        console.error("خطأ في الوصول إلى الميكروفون:", error);
        recordStatus.textContent = "❌ خطأ في الوصول إلى الميكروفون";
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordStatus.textContent = "⏹️ تم إيقاف التسجيل، جاهز للإرسال";
      }
    });

    // إرسال البيانات
    document.getElementById("surveyForm").addEventListener("submit", function(e) {
      e.preventDefault();

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = "جاري الإرسال...";
        progressBar.style.display = 'block';

        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;

        const phqAnswers = [];
        for (let i = 0; i < 8; i++) { // 8 أسئلة فقط
          const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
          phqAnswers.push(parseInt(answer));
        }

        const totalScore = phqAnswers.reduce((a, b) => a + b, 0);

        const formData = new FormData();
        formData.append("age", age);
        formData.append("gender", gender);
        formData.append("totalScore", totalScore);
        formData.append("phqAnswers", JSON.stringify(phqAnswers));
        formData.append("timestamp", new Date().toISOString());
        formData.append("phqVersion", "PHQ-8"); // إضافة إصدار الاستبيان

        if (audioBlob) {
          formData.append("audioFile", audioBlob, `recording_${Date.now()}.webm`);
        }

        const xhr = new XMLHttpRequest();
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzjXdSNqX-2qNweLuDb2yE93X5HFTXvBH4jLmKCrMFoWjtBVx5SpNp4HJIpx97A3MzY/exec';
        
        xhr.open('POST', scriptURL);
        
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
            fileInfo.textContent = `جاري الرفع: ${percentComplete.toFixed(1)}%`;
          }
        });

        xhr.onload = function() {
          progressBar.style.display = 'none';
          
          try {
            const response = JSON.parse(xhr.responseText);
            if (response.status === "success") {
              alert("✅ تم إرسال الاستبيان بنجاح!");
              document.getElementById("surveyForm").reset();
              audioBlob = null;
              fileInfo.textContent = "";
            } else {
              alert("❌ " + (response.message || "حدث خطأ غير متوقع"));
            }
          } catch (parseError) {
            alert("❌ خطأ في فهم response: " + xhr.responseText);
          }
          
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الاستبيان";
        };

        xhr.onerror = function() {
          progressBar.style.display = 'none';
          alert("❌ فشل الاتصال بالخادم. تأكد من:\n1. اتصال الإنترنت\n2. نشر السكريبت كـ Web App\n3. الصلاحيات: أي شخص");
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الاستبيان";
        };

        xhr.ontimeout = function() {
          progressBar.style.display = 'none';
          alert("⏰ انتهت مهلة الاتصال. حاول مرة أخرى.");
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الاستبيان";
        };

        xhr.timeout = 300000; // 5 دقائق
        xhr.send(formData);

      } catch (error) {
        console.error("خطأ في الإرسال:", error);
        alert("❌ حدث خطأ: " + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "إرسال الاستبيان";
        progressBar.style.display = 'none';
      }
    });

    // التحقق من دعم التسجيل الصوتي
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      recordStatus.textContent = "❌ المتصفح لا يدعم التسجيل الصوتي";
      recordBtn.disabled = true;
    }
  </script>
</body>
</html>
