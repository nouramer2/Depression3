<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨</title>
  <style>
    /* Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ */
    body {
      font-family: "Tahoma", sans-serif;
      background: #f4f6f9;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    /* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø³ØªØ§ÙŠÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ ... */
  </style>
</head>
<body>

  <h1>ğŸ“ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ (PHQ-9)</h1>

  <form id="surveyForm">
    <label>Ø§Ù„Ø¹Ù…Ø±:</label>
    <input type="number" id="age" name="age" required min="18" max="100">

    <label>Ø§Ù„Ù†ÙˆØ¹:</label>
    <select id="gender" name="gender" required>
      <option value="">Ø§Ø®ØªØ±</option>
      <option value="male">Ø°ÙƒØ±</option>
      <option value="female">Ø£Ù†Ø«Ù‰</option>
      <option value="other">Ø¢Ø®Ø±</option>
    </select>

    <!-- Ø£Ø³Ø¦Ù„Ø© PHQ-9 -->
    <div id="questions"></div>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª -->
    <h2>ğŸ¤ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</h2>
    <button type="button" id="recordBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button type="button" id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <p id="recordStatus">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯</p>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
    <div id="fileInfo" class="file-info"></div>

    <button type="submit" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
  </form>

  <script>
    const questionsText = [
      "Ù‚Ù„Ø© Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø£Ùˆ Ø§Ù„Ù…ØªØ¹Ø© Ø¨Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø§Ù„Ø£Ø´ÙŠØ§Ø¡",
      "Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„Ø¥Ø­Ø¨Ø§Ø· Ø£Ùˆ Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙŠØ£Ø³",
      "ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ù†ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù†ÙˆÙ… Ù„ÙØªØ±Ø§Øª Ø·ÙˆÙŠÙ„Ø©",
      "Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„ØªØ¹Ø¨ Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø·Ø§Ù‚Ø©",
      "Ø¶Ø¹Ù Ø§Ù„Ø´Ù‡ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥ÙØ±Ø§Ø· ÙÙŠ Ø§Ù„Ø£ÙƒÙ„",
      "Ø§Ù„Ø´Ø¹ÙˆØ± Ø§Ù„Ø³ÙŠØ¡ ØªØ¬Ø§Ù‡ Ù†ÙØ³Ùƒ Ø£Ùˆ Ø£Ù†Ùƒ ÙØ§Ø´Ù„",
      "ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
      "Ø§Ù„Ø­Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„ÙƒÙ„Ø§Ù… Ø¨Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯ Ø£Ùˆ Ø¨Ø³Ø±Ø¹Ø© Ù…ÙØ±Ø·Ø©",
      "Ø£ÙÙƒØ§Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆØª Ø£Ùˆ Ø¥ÙŠØ°Ø§Ø¡ Ø§Ù„Ù†ÙØ³"
    ];

    const questionsDiv = document.getElementById("questions");
    questionsText.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="q${i}" value="0" required> Ø£Ø¨Ø¯Ø§Ù‹</label>
        <label><input type="radio" name="q${i}" value="1"> Ø¹Ø¯Ø© Ø£ÙŠØ§Ù…</label>
        <label><input type="radio" name="q${i}" value="2"> Ø£ÙƒØ«Ø± Ù…Ù† Ù†ØµÙ Ø§Ù„Ø£ÙŠØ§Ù…</label>
        <label><input type="radio" name="q${i}" value="3"> ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…</label>
      `;
      questionsDiv.appendChild(div);
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let recordingStartTime;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordStatus = document.getElementById("recordStatus");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const fileInfo = document.getElementById("fileInfo");
    const submitBtn = document.getElementById("submitBtn");

    recordBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true
          } 
        });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recordingStartTime = Date.now();

        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const duration = Math.round((Date.now() - recordingStartTime) / 1000);
          const sizeMB = (audioBlob.size / (1024 * 1024)).toFixed(2);
          
          recordStatus.textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${duration} Ø«Ø§Ù†ÙŠØ© (${sizeMB} MB)`;
          fileInfo.textContent = `Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: ${sizeMB} MB - Ø§Ù„Ù…Ø¯Ø©: ${duration} Ø«Ø§Ù†ÙŠØ©`;
          
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordStatus.textContent = "ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
        recordBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:", error);
        recordStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordStatus.textContent = "â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„";
      }
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø¯Ù„
    document.getElementById("surveyForm").addEventListener("submit", function(e) {
      e.preventDefault();

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
        progressBar.style.display = 'block';

        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;

        const phqAnswers = [];
        for (let i = 0; i < 9; i++) {
          const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
          phqAnswers.push(parseInt(answer));
        }

        const totalScore = phqAnswers.reduce((a, b) => a + b, 0);

        const formData = new FormData();
        formData.append("age", age);
        formData.append("gender", gender);
        formData.append("totalScore", totalScore);
        formData.append("phqAnswers", JSON.stringify(phqAnswers));
        formData.append("timestamp", new Date().toISOString());

        if (audioBlob) {
          formData.append("audioFile", audioBlob, `recording_${Date.now()}.webm`);
        }

        const xhr = new XMLHttpRequest();
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzjXdSNqX-2qNweLuDb2yE93X5HFTXvBH4jLmKCrMFoWjtBVx5SpNp4HJIpx97A3MzY/exec';
        
        xhr.open('POST', scriptURL);
        xhr.responseType = 'json';

        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
            fileInfo.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹: ${percentComplete.toFixed(1)}%`;
          }
        });

        xhr.onload = function() {
          progressBar.style.display = 'none';
          
          if (xhr.status === 200) {
            const response = xhr.response;
            if (response && response.status === "success") {
              alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¨Ù†Ø¬Ø§Ø­!");
              document.getElementById("surveyForm").reset();
              audioBlob = null;
              fileInfo.textContent = "";
            } else {
              alert("âŒ " + (response?.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹"));
            }
          } else {
            alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: " + xhr.status);
          }
          
          submitBtn.disabled = false;
          submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
        };

        xhr.onerror = function() {
          progressBar.style.display = 'none';
          alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
        };

        xhr.ontimeout = function() {
          progressBar.style.display = 'none';
          alert("â° Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
        };

        // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚
        xhr.timeout = 300000;
        
        xhr.send(formData);

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
        progressBar.style.display = 'none';
      }
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      recordStatus.textContent = "âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ";
      recordBtn.disabled = true;
    }
  </script>
</body>
</html>

