<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استبيان الاكتئاب PHQ-8</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: #4a6fa5;
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        header h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .section {
            padding: 30px;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a6fa5;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            display: inline-block;
        }
        
        .btn:hover {
            background: #3a5a80;
        }
        
        .btn-container {
            text-align: center;
            margin-top: 30px;
        }
        
        .consent-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.8;
        }
        
        .phq-question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .phq-question h3 {
            margin-bottom: 15px;
            color: #4a6fa5;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .options {
                grid-template-columns: 1fr;
            }
        }
        
        .option {
            display: flex;
            align-items: center;
        }
        
        .option input {
            width: auto;
            margin-left: 10px;
        }
        
        .recorder {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .recorder-btn {
            background: #e74c3c;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 20px;
        }
        
        .recorder-btn.recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #4a6fa5;
        }
        
        .summary {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .summary h3 {
            margin-bottom: 15px;
            color: #4a6fa5;
            text-align: center;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4a6fa5;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .note {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-right: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>استبيان الصحة النفسية</h1>
            <p>نحن نهتم بمشاعرك خلال الأسبوعين الماضيين</p>
        </header>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <!-- قسم الموافقة -->
        <div class="section active" id="consent-section">
            <h2>موافقة المشاركة</h2>
            <div class="consent-text">
                <p>نشكرك على اهتمامك بالمشاركة في هذا الاستبيان الذي يهدف إلى فهم المشاعر والتجارب النفسية خلال الأسبوعين الماضيين.</p>
                <p>بياناتك ستستخدم لأغراض البحث العلمي فقط وستحافظ على سرية معلوماتك الشخصية. سيتم تخزين التسجيلات الصوتية والإجابات بشكل آمن.</p>
                <p>مشاركتك طوعية تمامًا ولك الحق في سحب موافقتك في أي وقت دون أي عواقب.</p>
                <p>بالنقر على "أوافق" أدناه، فإنك توافق على المشاركة في هذا البحث وتؤكد أنك قد قرأت وفهمت المعلومات المقدمة.</p>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="consent-checkbox">
                    أوافق على المشاركة في الاستبيان
                </label>
            </div>
            <div class="btn-container">
                <button class="btn" id="consent-btn" disabled>المتابعة</button>
            </div>
        </div>
        
        <!-- قسم المعلومات الشخصية -->
        <div class="section" id="info-section">
            <h2>المعلومات الشخصية</h2>
            <div class="form-group">
                <label for="age">العمر:</label>
                <input type="number" id="age" min="18" max="100" placeholder="أدخل عمرك">
            </div>
            <div class="form-group">
                <label for="gender">الجنس:</label>
                <select id="gender">
                    <option value="">اختر الجنس</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                    <option value="other">أخرى</option>
                </select>
            </div>
            <div class="btn-container">
                <button class="btn" id="info-btn">المتابعة</button>
            </div>
        </div>
        
        <!-- قسم التسجيل الصوتي -->
        <div class="section" id="record-section">
            <h2>تسجيل المشاعر</h2>
            <p>يرجى التحدث عن مشاعرك خلال الأسبوعين الماضيين. اضغط على زر التسجيل وابدأ بالتحدث لمدة تصل إلى 5 دقائق.</p>
            
            <div class="note">
                <p>ملاحظة: يمكنك التسجيل لمدة تصل إلى 5 دقائق. سيتم حفظ التسجيل تلقائيًا عند إيقافه.</p>
            </div>
            
            <div class="recorder">
                <button class="recorder-btn" id="record-btn">●</button>
                <div class="timer" id="timer">00:00</div>
                <p id="record-status">لم يبدأ التسجيل بعد</p>
                <p id="time-limit">الحد الأقصى للتسجيل: 5 دقائق</p>
            </div>
            
            <div class="btn-container">
                <button class="btn" id="record-next-btn" disabled>المتابعة</button>
            </div>
        </div>
        
        <!-- قسم استبيان PHQ-8 -->
        <div class="section" id="phq-section">
            <h2>استبيان PHQ-8</h2>
            <p>يرجى الإجابة على الأسئلة التالية حول مشاعرك خلال الأسبوعين الماضيين:</p>
            
            <div id="phq-questions">
                <!-- سيتم إضافة الأسئلة ديناميكيًا -->
            </div>
            
            <div class="btn-container">
                <button class="btn" id="phq-btn">إرسال الاستبيان</button>
            </div>
        </div>
        
        <!-- قسم النتائج -->
        <div class="section" id="results-section">
            <h2>شكراً لمشاركتك!</h2>
            <div class="summary">
                <h3>ملخص الاستبيان</h3>
                <p>العمر: <span id="summary-age"></span></p>
                <p>الجنس: <span id="summary-gender"></span></p>
                <p>نتيجة PHQ-8: <span id="summary-score"></span></p>
                <p>سيتم إرسال البيانات إلى الباحثين.</p>
            </div>
            <div class="btn-container">
                <button class="btn" id="restart-btn">بدء استبيان جديد</button>
            </div>
        </div>
    </div>

    <script>
        // بيانات الأسئلة لاستبيان PHQ-8
        const phqQuestions = [
            "قلة الاهتمام أو المتعة في doing things",
            "شعور بالإحباط أو الاكتئاب أو اليأس",
            "صعوبة في النوم أو البقاء نائماً، أو النوم أكثر من اللازم",
            "الشعور بالتعب أو قلة الطاقة",
            "قلة الشهية أو الإفراط في الأكل",
            "شعور بعدم الرضا عن النفس أو أنك فاشل أو أنك خذلت نفسك أو عائلتك",
            "صعوبة في التركيز على الأشياء، مثل قراءة الجريدة أو مشاهدة التلفزيون",
            "تحرك أو تكلم ببطء شديد بحيث يمكن للآخرين ملاحظته؟ أو على العكس من ذلك، تشعر بعدم الاستقرار أو التململ بحيث تتحرك أكثر من المعتاد"
        ];

        const options = [
            "ليس على الإطلاق",
            "عدة أيام",
            "أكثر من نصف الأيام",
            "كل يوم تقريباً"
        ];

        // عناصر DOM
        const progressBar = document.getElementById('progress');
        const sections = document.querySelectorAll('.section');
        let currentSection = 0;

        // عناصر التسجيل الصوتي
        const recordBtn = document.getElementById('record-btn');
        const timer = document.getElementById('timer');
        const recordStatus = document.getElementById('record-status');
        const recordNextBtn = document.getElementById('record-next-btn');
        let mediaRecorder;
        let audioChunks = [];
        let recording = false;
        let seconds = 0;
        let timerInterval;
        const MAX_RECORDING_TIME = 300; // 5 دقائق بالثواني

        // تحديث شريط التقدم
        function updateProgress() {
            const progress = ((currentSection + 1) / sections.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // الانتقال إلى القسم التالي
        function nextSection() {
            sections[currentSection].classList.remove('active');
            currentSection++;
            
            if (currentSection < sections.length) {
                sections[currentSection].classList.add('active');
                updateProgress();
                
                // إذا كان القسم التالي هو قسم الأسئلة، قم ببنائها
                if (currentSection === 3) {
                    buildPHQQuestions();
                }
                
                // إذا كان القسم التالي هو قسم النتائج، قم بعرضها
                if (currentSection === 4) {
                    showSummary();
                }
            }
        }

        // بناء أسئلة PHQ-8
        function buildPHQQuestions() {
            const container = document.getElementById('phq-questions');
            container.innerHTML = '';
            
            phqQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'phq-question';
                
                questionDiv.innerHTML = `
                    <h3>${index + 1}. ${question}</h3>
                    <div class="options">
                        ${options.map((option, optIndex) => `
                            <div class="option">
                                <input type="radio" id="q${index}-opt${optIndex}" name="q${index}" value="${optIndex}" required>
                                <label for="q${index}-opt${optIndex}">${option} (${optIndex})</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(questionDiv);
            });
        }

        // عرض ملخص النتائج
        function showSummary() {
            document.getElementById('summary-age').textContent = document.getElementById('age').value;
            document.getElementById('summary-gender').textContent = document.getElementById('gender').options[document.getElementById('gender').selectedIndex].text;
            
            // حساب نتيجة PHQ-8
            let score = 0;
            for (let i = 0; i < phqQuestions.length; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (selectedOption) {
                    score += parseInt(selectedOption.value);
                }
            }
            
            document.getElementById('summary-score').textContent = score;
            
            // إرسال البيانات إلى الخادم
            sendDataToServer(score);
        }

        // إرسال البيانات إلى الخادم
        function sendDataToServer(score) {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            
            // هذا مثال لكيفية إرسال البيانات
            // في الواقع، ستحتاج إلى نشر تطبيق Google Apps Script واستخدام URL الخاص به
            const scriptURL = 'https://script.google.com/macros/s/AKfycbwYLP5J-1IjDW1VpCN1A2lVj_o-A9p8aIl6f62PSAwX94EDtomRVPzryZiFLVFiXp4u/exec';
            
            const formData = new FormData();
            formData.append('age', age);
            formData.append('gender', gender);
            formData.append('score', score);
            formData.append('timestamp', new Date().toISOString());
            
            // إذا كان لدينا تسجيل صوتي، أضفه
            if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                formData.append('audio', audioBlob, 'recording.webm');
            }
            
            fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                console.log('تم إرسال البيانات بنجاح!', data);
            })
            .catch(error => {
                console.error('Error!', error.message);
                alert('حدث خطأ في إرسال البيانات. يرجى المحاولة مرة أخرى.');
            });
        }

        // بدء/إيقاف التسجيل
        recordBtn.addEventListener('click', async () => {
            if (!recording) {
                // بدء التسجيل
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.start(1000); // جمع البيانات كل ثانية
                    recording = true;
                    recordBtn.classList.add('recording');
                    recordStatus.textContent = "جاري التسجيل...";
                    recordStatus.style.color = "#e74c3c";
                    
                    // بدء المؤقت
                    seconds = 0;
                    timerInterval = setInterval(() => {
                        seconds++;
                        const mins = Math.floor(seconds / 60);
                        const secs = seconds % 60;
                        timer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                        
                        // إيقاف التسجيل تلقائياً بعد 5 دقائق
                        if (seconds >= MAX_RECORDING_TIME) {
                            stopRecording();
                            alert("تم الوصول إلى الحد الأقصى للتسجيل (5 دقائق)");
                        }
                    }, 1000);
                } catch (error) {
                    console.error("Error accessing microphone:", error);
                    alert("تعذر الوصول إلى الميكروفون. يرجى التحقق من الأذونات.");
                }
            } else {
                stopRecording();
            }
        });

        // إيقاف التسجيل
        function stopRecording() {
            if (mediaRecorder && recording) {
                mediaRecorder.stop();
                recording = false;
                recordBtn.classList.remove('recording');
                recordStatus.textContent = "تم التسجيل بنجاح";
                recordStatus.style.color = "#27ae60";
                clearInterval(timerInterval);
                recordNextBtn.disabled = false;
                
                // إيقاف جميع tracks في stream
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        // أحداث الأزرار
        document.getElementById('consent-checkbox').addEventListener('change', function() {
            document.getElementById('consent-btn').disabled = !this.checked;
        });

        document.getElementById('consent-btn').addEventListener('click', nextSection);
        document.getElementById('info-btn').addEventListener('click', function() {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            
            if (age && gender) {
                nextSection();
            } else {
                alert("يرجى ملء جميع الحقول");
            }
        });
        
        document.getElementById('record-next-btn').addEventListener('click', nextSection);
        document.getElementById('phq-btn').addEventListener('click', function() {
            // التحقق من أن جميع الأسئلة قد تمت الإجابة عليها
            let allAnswered = true;
            for (let i = 0; i < phqQuestions.length; i++) {
                if (!document.querySelector(`input[name="q${i}"]:checked`)) {
                    allAnswered = false;
                    break;
                }
            }
            
            if (allAnswered) {
                nextSection();
            } else {
                alert("يرجى الإجابة على جميع الأسئلة");
            }
        });

        document.getElementById('restart-btn').addEventListener('click', function() {
            location.reload();
        });

        // تحديث شريط التقدم في البداية
        updateProgress();
    </script>
</body>
</html>
