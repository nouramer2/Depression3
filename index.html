<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>استبيان الاكتئاب</title>
  <style>
    body { font-family: Tahoma, sans-serif; background: #f4f6f9; text-align: center; padding: 20px; }
    h1 { color: #333; }
    .hidden { display: none; }
    button { margin: 10px; padding: 10px 20px; border: none; background: #4CAF50; color: white; cursor: pointer; border-radius: 8px; }
    button:disabled { background: #aaa; }
    input, select { margin: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h1>استبيان الاكتئاب (PHQ-8)</h1>
  
  <!-- موافقة -->
  <div id="consent">
    <p>بالضغط على موافق، أنت توافق على المشاركة في هذا الاستبيان وتسجيل صوتك.</p>
    <button onclick="startSurvey()">موافق</button>
  </div>

  <!-- البيانات -->
  <div id="demographics" class="hidden">
    <h3>البيانات الأساسية</h3>
    <label>العمر: <input type="number" id="age"></label><br>
    <label>الجنس: 
      <select id="sex">
        <option value="ذكر">ذكر</option>
        <option value="أنثى">أنثى</option>
      </select>
    </label><br>
    <button onclick="nextStep('recording')">التالي</button>
  </div>

  <!-- تسجيل صوت -->
  <div id="recording" class="hidden">
    <h3>سجل صوتك (حتى 5 دقائق) وتحدث عن مشاعرك خلال آخر أسبوعين</h3>
    <button id="startRec">ابدأ التسجيل</button>
    <button id="stopRec" disabled>أوقف التسجيل</button>
    <p id="recordStatus"></p>
    <audio id="audioPlayback" controls></audio><br>
    <button onclick="nextStep('phq8')" id="goPhq8" disabled>التالي</button>
  </div>

  <!-- أسئلة PHQ-8 -->
  <div id="phq8" class="hidden">
    <h3>أسئلة PHQ-8</h3>
    <div id="questions"></div>
    <button onclick="submitAll()">إرسال</button>
  </div>

  <p id="result"></p>

<script>
let mediaRecorder, audioChunks = [], audioBase64 = "";
const questionsText = [
  "قلة الاهتمام أو المتعة في القيام بالأشياء؟",
  "الشعور بالاكتئاب أو اليأس؟",
  "مشاكل في النوم (قلة النوم أو النوم الزائد)؟",
  "الشعور بالتعب أو قلة الطاقة؟",
  "ضعف الشهية أو الإفراط في الأكل؟",
  "الشعور بسوء عن نفسك أو الشعور بالفشل؟",
  "صعوبة التركيز على الأشياء؟",
  "بطء في الحركة أو الكلام أو العكس (توتر زائد)؟"
];

function startSurvey() {
  document.getElementById('consent').classList.add('hidden');
  document.getElementById('demographics').classList.remove('hidden');
}

function nextStep(stepId) {
  document.querySelectorAll('div').forEach(d => d.classList.add('hidden'));
  document.getElementById(stepId).classList.remove('hidden');
}

document.getElementById('startRec').onclick = async function() {
  let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.onstop = async () => {
    let blob = new Blob(audioChunks, { type: 'audio/webm' });
    let reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = () => {
      audioBase64 = reader.result.split(",")[1]; // ناخد بس الجزء Base64
      document.getElementById('recordStatus').innerText = "تم تسجيل الصوت.";
      document.getElementById('audioPlayback').src = URL.createObjectURL(blob);
      document.getElementById('goPhq8').disabled = false;
    };
  };
  mediaRecorder.start();
  document.getElementById('recordStatus').innerText = "جاري التسجيل...";
  document.getElementById('startRec').disabled = true;
  document.getElementById('stopRec').disabled = false;
};

document.getElementById('stopRec').onclick = function() {
  mediaRecorder.stop();
  document.getElementById('recordStatus').innerText = "جاري معالجة الصوت...";
  document.getElementById('startRec').disabled = false;
  document.getElementById('stopRec').disabled = true;
};

// بناء أسئلة PHQ-8
let qDiv = document.getElementById('questions');
questionsText.forEach((q, i) => {
  let html = `<p>${q}</p>
    <select id="q${i}">
      <option value="0">أبداً (0)</option>
      <option value="1">عدة أيام (1)</option>
      <option value="2">أكثر من نصف الأيام (2)</option>
      <option value="3">تقريباً كل يوم (3)</option>
    </select>`;
  qDiv.innerHTML += html;
});

async function submitAll() {
  let age = document.getElementById('age').value;
  let sex = document.getElementById('sex').value;
  let score = 0;
  for (let i = 0; i < 8; i++) score += parseInt(document.getElementById('q'+i).value);

  if (!audioBase64) {
    alert("من فضلك سجل صوتك أولاً!");
    return;
  }

  let data = { age, sex, score, audio: audioBase64 };

  let response = await fetch("https://script.google.com/macros/s/AKfycbyggPtV8BUsScaXgA01kf20q0iyEjsVqgvnQfFZ8l6SVhq9_PFgwfp7fEWhgcWq57et/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" }
  });

  let result = await response.text();
  document.getElementById('result').innerText = result;
}
</script>
</body>
</html>
