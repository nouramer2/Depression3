<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>استبيان الاكتئاب</title>
  <style>
    body {
      font-family: "Tahoma", sans-serif;
      background: #f4f6f9;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    form {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 18px;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
    }
    input, select {
      padding: 10px;
      width: 95%;
      font-size: 16px;
      margin-bottom: 15px;
    }
    .question {
      margin: 20px 0;
      text-align: right;
    }
    .question p {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .question label {
      font-weight: normal;
      margin-left: 10px;
    }
    button {
      padding: 12px 20px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
    }
    #recordBtn { background: #007bff; color: white; }
    #stopBtn { background: #dc3545; color: white; }
    #submitBtn { background: #28a745; color: white; width: 100%; }
  </style>
</head>
<body>

  <h1>📝 استبيان الاكتئاب (PHQ-9)</h1>

  <form id="surveyForm">
    <label>العمر:</label>
    <input type="number" id="age" name="age" required min="18" max="100">

    <label>النوع:</label>
    <select id="gender" name="gender" required>
      <option value="">اختر</option>
      <option value="male">ذكر</option>
      <option value="female">أنثى</option>
      <option value="other">آخر</option>
    </select>

    <!-- أسئلة PHQ-9 -->
    <div id="questions"></div>

    <!-- تسجيل الصوت -->
    <h2>🎤 التسجيل الصوتي</h2>
    <button type="button" id="recordBtn">ابدأ التسجيل</button>
    <button type="button" id="stopBtn" disabled>إيقاف التسجيل</button>
    <p id="recordStatus">لم يبدأ التسجيل بعد</p>

    <button type="submit" id="submitBtn">إرسال الاستبيان</button>
  </form>

  <script>
    const questionsText = [
      "قلة الاهتمام أو المتعة بالقيام بالأشياء",
      "الشعور بالإحباط أو الاكتئاب أو اليأس",
      "صعوبة النوم أو النوم لفترات طويلة",
      "الشعور بالتعب أو فقدان الطاقة",
      "ضعف الشهية أو الإفراط في الأكل",
      "الشعور السيء تجاه نفسك أو أنك فاشل",
      "صعوبة التركيز في الأنشطة اليومية",
      "الحركة أو الكلام ببطء شديد أو بسرعة مفرطة",
      "أفكار عن الموت أو إيذاء النفس"
    ];

    const questionsDiv = document.getElementById("questions");
    questionsText.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="q${i}" value="0" required> أبداً</label>
        <label><input type="radio" name="q${i}" value="1"> عدة أيام</label>
        <label><input type="radio" name="q${i}" value="2"> أكثر من نصف الأيام</label>
        <label><input type="radio" name="q${i}" value="3"> تقريباً كل يوم</label>
      `;
      questionsDiv.appendChild(div);
    });

    // تسجيل الصوت
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordStatus = document.getElementById("recordStatus");

    recordBtn.addEventListener("click", async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        recordStatus.textContent = "✅ تم تسجيل الصوت بنجاح";
      };

      mediaRecorder.start();
      recordStatus.textContent = "🔴 جاري التسجيل...";
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    });

    stopBtn.addEventListener("click", () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      recordStatus.textContent = "⏹️ تم إيقاف التسجيل، جاهز للإرسال";
    });

    // إرسال البيانات
    document.getElementById("surveyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const age = document.getElementById("age").value;
      const gender = document.getElementById("gender").value;

      const phqAnswers = [];
      for (let i = 0; i < 9; i++) {
        const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
        phqAnswers.push(parseInt(answer));
      }

      const totalScore = phqAnswers.reduce((a, b) => a + b, 0);

      const formData = new FormData();
      formData.append("age", age);
      formData.append("gender", gender);
      formData.append("totalScore", totalScore);
      formData.append("phqAnswers", JSON.stringify(phqAnswers));
      formData.append("timestamp", new Date().toISOString());

      if (audioBlob) {
        formData.append("audioFile", audioBlob, "recording.webm");
      }

      const response = await fetch("https://script.google.com/macros/s/AKfycby3l6fZxOqa7KmJnqKIZN2nqmeIaTcWzarcwVD3OYI4WcQvWelf2LCwLLQO-wqT8I9f/exec", {
        method: "POST",
        body: formData
      });

      const result = await response.json();
      alert(result.message);
    });
  </script>
</body>
</html>

