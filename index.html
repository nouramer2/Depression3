<!DOCTYPE html>
<html>
<head>
  <title>استبيان الاكتئاب</title>
</head>
<body>
  <h2>مشاركة في استبيان الاكتئاب</h2>
  <form id="surveyForm">
    <label>
      أوافق على المشاركة:
      <input type="checkbox" id="consent" required> نعم
    </label>
    <br><br>
    <label>
      العمر:
      <input type="number" id="age" required>
    </label>
    <br><br>
    <label>
      الجنس:
      <select id="sex" required>
        <option value="">اختر الجنس</option>
        <option value="ذكر">ذكر</option>
        <option value="أنثى">أنثى</option>
      </select>
    </label>
    <br><br>
    <h3>تسجيل صوتي عن مشاعرك خلال الأسبوعين الماضيين (حتى 5 دقائق)</h3>
    <audio id="audioPlayback" controls></audio>
    <br>
    <button type="button" onclick="startRecording()">ابدأ التسجيل</button>
    <button type="button" onclick="stopRecording()" disabled>إيقاف التسجيل</button>
    <br><br>
    <h3>أسئلة PHQ-8 (اختر الإجابة لكل سؤال)</h3>
    <div id="phq8Questions">
      <!-- Questions will be dynamically added -->
    </div>
    <button type="button" onclick="calculatePHQ8()">احسب النتيجة</button>
    <br><br>
    <div id="phq8ScoreDisplay"></div>
    <br>
    <button type="submit">إرسال البيانات</button>
  </form>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let recordedBlob = null;
    let phq8Answers = [];
    let phq8Score = 0;

    // أسئلة PHQ-8
    const questions = [
      "شعرت بالحزن أو اليأس خلال الأسبوعين الماضيين",
      "فقدت اهتمامي أو متعة في الأنشطة التي كنت أتمتع بها سابقًا",
      "شعرت بالتعب أو نقص الطاقة",
      "واجهت مشاكل في النوم أو النوم المفرط",
      "شعرت بعدم القدرة على التركيز",
      "شعرت بعدم القيمة أو الذنب",
      "فكرت في الموت أو الانتحار",
      "واجهت تغيرات في الشهية أو الوزن"
    ];

    // عرض الأسئلة
    const questionsDiv = document.getElementById('phq8Questions');
    questions.forEach((q, index) => {
      questionsDiv.innerHTML += `
        <p>${q}</p>
        <label><input type="radio" name="q${index}" value="0" required> نادرًا أو لا أواجه</label>
        <label><input type="radio" name="q${index}" value="1"> أحيانًا</label>
        <label><input type="radio" name="q${index}" value="2"> أكثر من نصف الأيام</label>
        <label><input type="radio" name="q${index}" value="3"> تقريبًا كل يوم</label>
        <br><br>
      `;
    });

    // حساب درجة PHQ-8
    function calculatePHQ8() {
      phq8Answers = [];
      for (let i = 0; i < questions.length; i++) {
        const answer = document.querySelector(`input[name="q${i}"]:checked`);
        if (answer) {
          phq8Answers.push(parseInt(answer.value));
        } else {
          alert("يرجى الإجابة على جميع الأسئلة");
          return;
        }
      }
      phq8Score = phq8Answers.reduce((a, b) => a + b, 0);
      document.getElementById('phq8ScoreDisplay').innerText = `درجة PHQ-8 الخاصة بك: ${phq8Score}`;
    }

    // بدء التسجيل
    async function startRecording() {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];
        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };
        document.querySelector('button[onclick="stopRecording()"]').disabled = false;
      } else {
        alert("متصفحك لا يدعم تسجيل الصوت");
      }
    }

    // إيقاف التسجيل
    function stopRecording() {
      mediaRecorder.stop();
      mediaRecorder.onstop = () => {
        recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(recordedBlob);
        document.getElementById('audioPlayback').src = url;
        document.querySelector('button[onclick="stopRecording()"]').disabled = true;
      };
    }

    // إرسال البيانات
    document.getElementById('surveyForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!recordedBlob) {
        alert("يرجى تسجيل الصوت");
        return;
      }
      if (phq8Score === 0) {
        alert("يرجى حساب درجة PHQ-8");
        return;
      }
      const age = document.getElementById('age').value;
      const sex = document.getElementById('sex').value;

      // رفع الصوت إلى Google Drive
      const formData = new FormData();
      formData.append('audio', recordedBlob, 'recording.webm');

      const response = await fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();

      const audioFileUrl = result.fileUrl; // رابط الملف على Google Drive

      // إرسال البيانات إلى Google Sheets و البريد الإلكتروني عبر Google Apps Script
      const data = {
        age: age,
        sex: sex,
        phq8Score: phq8Score,
        driveFileUrl: audioFileUrl
      };

      await fetch('https://script.google.com/macros/s/AKfycbxDiNQ8iRXltI6732Fj6OmG7jUX2fHXXFEHGEvGO6BVdijvAn5wI9ja20ja-G0qIwxz/exec', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });

      alert('تم إرسال البيانات بنجاح!');
    });
  </script>
</body>
</html>
