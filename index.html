<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨</title>
  <style>
    body {
      font-family: "Tahoma", sans-serif;
      background: #f4f6f9;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    form {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 18px;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
      text-align: right;
    }
    input, select {
      padding: 10px;
      width: 95%;
      font-size: 16px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .question {
      margin: 20px 0;
      text-align: right;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    .question p {
      font-size: 18px;
      margin-bottom: 10px;
      font-weight: bold;
      color: #444;
    }
    .question label {
      font-weight: normal;
      margin-left: 15px;
      display: inline-block;
      padding: 8px 15px;
      background: #f8f9fa;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .question label:hover {
      background: #e9ecef;
    }
    .question input[type="radio"] {
      width: auto;
      margin-left: 5px;
    }
    button {
      padding: 12px 25px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
    }
    #recordBtn { 
      background: #007bff; 
      color: white; 
    }
    #recordBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #stopBtn { 
      background: #dc3545; 
      color: white; 
    }
    #stopBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #submitBtn { 
      background: #28a745; 
      color: white; 
      width: 100%;
      padding: 15px;
      font-size: 20px;
      margin-top: 20px;
    }
    #submitBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #recordStatus {
      font-size: 16px;
      margin: 15px 0;
      color: #666;
    }
    #progressBar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    #progressFill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #28a745);
      width: 0%;
      transition: width 0.3s;
    }
    .file-info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border-right: 4px solid #007bff;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <h1>ğŸ“ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ (PHQ-9)</h1>

  <form id="surveyForm">
    <label>Ø§Ù„Ø¹Ù…Ø±:</label>
    <input type="number" id="age" name="age" required min="18" max="100">

    <label>Ø§Ù„Ù†ÙˆØ¹:</label>
    <select id="gender" name="gender" required>
      <option value="">Ø§Ø®ØªØ±</option>
      <option value="male">Ø°ÙƒØ±</option>
      <option value="female">Ø£Ù†Ø«Ù‰</option>
      <option value="other">Ø¢Ø®Ø±</option>
    </select>

    <!-- Ø£Ø³Ø¦Ù„Ø© PHQ-9 -->
    <div id="questions"></div>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª -->
    <h2>ğŸ¤ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</h2>
    <button type="button" id="recordBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button type="button" id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <p id="recordStatus">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯</p>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
    <div id="fileInfo" class="file-info"></div>

    <button type="submit" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
  </form>

  <script>
    const questionsText = [
      "Ù‚Ù„Ø© Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø£Ùˆ Ø§Ù„Ù…ØªØ¹Ø© Ø¨Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø§Ù„Ø£Ø´ÙŠØ§Ø¡",
      "Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„Ø¥Ø­Ø¨Ø§Ø· Ø£Ùˆ Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙŠØ£Ø³",
      "ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ù†ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù†ÙˆÙ… Ù„ÙØªØ±Ø§Øª Ø·ÙˆÙŠÙ„Ø©",
      "Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„ØªØ¹Ø¨ Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø·Ø§Ù‚Ø©",
      "Ø¶Ø¹Ù Ø§Ù„Ø´Ù‡ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥ÙØ±Ø§Ø· ÙÙŠ Ø§Ù„Ø£ÙƒÙ„",
      "Ø§Ù„Ø´Ø¹ÙˆØ± Ø§Ù„Ø³ÙŠØ¡ ØªØ¬Ø§Ù‡ Ù†ÙØ³Ùƒ Ø£Ùˆ Ø£Ù†Ùƒ ÙØ§Ø´Ù„",
      "ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
      "Ø§Ù„Ø­Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„ÙƒÙ„Ø§Ù… Ø¨Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯ Ø£Ùˆ Ø¨Ø³Ø±Ø¹Ø© Ù…ÙØ±Ø·Ø©",
      "Ø£ÙÙƒØ§Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆØª Ø£Ùˆ Ø¥ÙŠØ°Ø§Ø¡ Ø§Ù„Ù†ÙØ³"
    ];

    const questionsDiv = document.getElementById("questions");
    questionsText.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="q${i}" value="0" required> Ø£Ø¨Ø¯Ø§Ù‹</label>
        <label><input type="radio" name="q${i}" value="1"> Ø¹Ø¯Ø© Ø£ÙŠØ§Ù…</label>
        <label><input type="radio" name="q${i}" value="2"> Ø£ÙƒØ«Ø± Ù…Ù† Ù†ØµÙ Ø§Ù„Ø£ÙŠØ§Ù…</label>
        <label><input type="radio" name="q${i}" value="3"> ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…</label>
      `;
      questionsDiv.appendChild(div);
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let recordingStartTime;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordStatus = document.getElementById("recordStatus");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const fileInfo = document.getElementById("fileInfo");
    const submitBtn = document.getElementById("submitBtn");

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    const audioSettings = {
      audioBitsPerSecond: 64000, // 64 kbps - Ø¬ÙˆØ¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ÙƒÙ„Ø§Ù…
      mimeType: 'audio/webm;codecs=opus'
    };

    recordBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1, // Ù…ÙˆÙ†Ùˆ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
            echoCancellation: true,
            noiseSuppression: true
          } 
        });
        
        mediaRecorder = new MediaRecorder(stream, audioSettings);
        audioChunks = [];
        recordingStartTime = Date.now();

        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const duration = Math.round((Date.now() - recordingStartTime) / 1000);
          const sizeMB = (audioBlob.size / (1024 * 1024)).toFixed(2);
          
          recordStatus.textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${duration} Ø«Ø§Ù†ÙŠØ© (${sizeMB} MB)`;
          fileInfo.textContent = `Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: ${sizeMB} MB - Ø§Ù„Ù…Ø¯Ø©: ${duration} Ø«Ø§Ù†ÙŠØ©`;
          
          // ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordStatus.textContent = "ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
        recordStatus.innerHTML += ' <span class="loading"></span>';
        recordBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:", error);
        recordStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordStatus.textContent = "â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„";
      }
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById("surveyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      try {
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        submitBtn.disabled = true;
        submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;

        const phqAnswers = [];
        for (let i = 0; i < 9; i++) {
          const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
          phqAnswers.push(parseInt(answer));
        }

        const totalScore = phqAnswers.reduce((a, b) => a + b, 0);

        const formData = new FormData();
        formData.append("age", age);
        formData.append("gender", gender);
        formData.append("totalScore", totalScore);
        formData.append("phqAnswers", JSON.stringify(phqAnswers));
        formData.append("timestamp", new Date().toISOString());

        if (audioBlob) {
          formData.append("audioFile", audioBlob, `recording_${Date.now()}.webm`);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        progressBar.style.display = 'block';
        fileInfo.textContent = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...";

        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
            fileInfo.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹: ${percentComplete.toFixed(1)}% (${(e.loaded / (1024 * 1024)).toFixed(2)} MB / ${(e.total / (1024 * 1024)).toFixed(2)} MB)`;
          }
        });

        xhr.addEventListener('load', () => {
          try {
            const result = JSON.parse(xhr.responseText);
            if (result.status === "success") {
              alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¨Ù†Ø¬Ø§Ø­!");
              // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
              document.getElementById("surveyForm").reset();
              audioBlob = null;
              fileInfo.textContent = "";
              progressBar.style.display = 'none';
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + error.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
          }
        });

        xhr.addEventListener('error', () => {
          alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
          submitBtn.disabled = false;
          submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
        });

        xhr.open('POST', 'https://script.google.com/macros/s/AKfycby3l6fZxOqa7KmJnqKIZN2nqmeIaTcWzarcwVD3OYI4WcQvWelf2LCwLLQO-wqT8I9f/exec');
        xhr.send(formData);

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†";
      }
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      recordStatus.textContent = "âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ";
      recordBtn.disabled = true;
    }
  </script>
</body>
</html>
