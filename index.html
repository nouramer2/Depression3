<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استبيان الصحة النفسية</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .consent {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .question {
            margin-bottom: 15px;
        }
        .options {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        .option {
            flex: 1;
            text-align: center;
            padding: 5px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            width: 200px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .record-container {
            text-align: center;
            margin: 20px 0;
        }
        #recordButton {
            background-color: #e74c3c;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 16px;
        }
        #recordButton.recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #timer {
            font-size: 24px;
            margin: 10px 0;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
            text-align: center;
        }
        .note {
            background-color: #fff3cd;
            border-left: 4px solid #ffeeba;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>استبيان الصحة النفسية</h1>
        
        <div id="consentSection" class="section">
            <h2>موافقة المشاركة</h2>
            <div class="consent">
                <p>نحن ندعوك للمشاركة في استبيان حول الصحة النفسية. سيطلب منك هذا الاستبيان الإجابة على بعض الأسئلة حول مشاعرك خلال الأسبوعين الماضيين، وكذلك تسجيل رسالة صوتية قصيرة.</p>
                <p>جميع البيانات التي تقدمها ستبقى سرية وسيتم استخدامها لأغراض البحث العلمي فقط. سيتم تخزين البيانات في بيئة آمنة ولن يتم الكشف عن هويتك الشخصية.</p>
                <p>مشاركتك طوعية تمامًا، ولديك الحق في سحب موافقتك في أي وقت دون أي عواقب.</p>
                <p>بالنقر على "أوافق"، فإنك تقر بأنك قد قرأت وفهمت المعلومات المذكورة أعلاه وتوافق على المشاركة في هذا الاستبيان.</p>
            </div>
            <label>
                <input type="checkbox" id="consentCheckbox">
                أوافق على المشاركة في الاستبيان
            </label>
        </div>

        <div id="demographicsSection" class="section hidden">
            <h2>المعلومات الديموغرافية</h2>
            <div>
                <label for="age">العمر:</label>
                <input type="number" id="age" name="age" min="18" max="100" required>
            </div>
            <div>
                <label for="gender">الجنس:</label>
                <select id="gender" name="gender" required>
                    <option value="">اختر الجنس</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                    <option value="other">أخرى</option>
                </select>
            </div>
        </div>

        <div id="recordingSection" class="section hidden">
            <h2>التسجيل الصوتي</h2>
            <p>يرجى التحدث عن مشاعرك خلال الأسبوعين الماضيين. سيتمكن الباحثون من الاستماع إلى هذا التسجيل لفهم تجربتك بشكل أفضل.</p>
            <div class="note">
                <strong>ملاحظة:</strong> إذا لم يظهر زر التسجيل، يرجى التأكد من:
                <ul>
                    <li>استخدام متصفح حديث مثل Chrome أو Firefox</li>
                    <li>السماح للموقع باستخدام الميكروفون</li>
                    <li>الاتصال بالإنترنت</li>
                </ul>
            </div>
            <div class="record-container">
                <button id="recordButton">بدء التسجيل</button>
                <div id="timer">00:00</div>
                <audio id="audioPlayback" controls class="hidden"></audio>
            </div>
        </div>

        <div id="phq8Section" class="section hidden">
            <h2>استبيان PHQ-8</h2>
            <p>خلال الأسبوعين الماضيين، كم مرة شعرت بالانزعاج بسبب أي من المشكلات التالية:</p>
            
            <div class="question">
                <p>1. قلة الاهتمام أو المتعة في doing things</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q1" value="0" id="q1_0" required><label for="q1_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q1" value="1" id="q1_1"><label for="q1_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q1" value="2" id="q1_2"><label for="q1_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q1" value="3" id="q1_3"><label for="q1_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>2. الشعور باليأس أو الاكتئاب أو الحزن</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q2" value="0" id="q2_0" required><label for="q2_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q2" value="1" id="q2_1"><label for="q2_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q2" value="2" id="q2_2"><label for="q2_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q2" value="3" id="q2_3"><label for="q2_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>3. صعوبة في النوم أو النوم أكثر من اللازم</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q3" value="0" id="q3_0" required><label for="q3_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q3" value="1" id="q3_1"><label for="q3_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q3" value="2" id="q3_2"><label for="q3_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q3" value="3" id="q3_3"><label for="q3_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>4. الشعور بالتعب أو قلة الطاقة</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q4" value="0" id="q4_0" required><label for="q4_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q4" value="1" id="q4_1"><label for="q4_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q4" value="2" id="q4_2"><label for="q4_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q4" value="3" id="q4_3"><label for="q4_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>5. قلة الشهية أو الإفراط في الأكل</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q5" value="0" id="q5_0" required><label for="q5_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q5" value="1" id="q5_1"><label for="q5_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q5" value="2" id="q5_2"><label for="q5_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q5" value="3" id="q5_3"><label for="q5_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>6. الشعور بعدم الرضا عن نفسك أو أنك فاشل أو أنك خذلت نفسك أو عائلتك</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q6" value="0" id="q6_0" required><label for="q6_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q6" value="1" id="q6_1"><label for="q6_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q6" value="2" id="q6_2"><label for="q6_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q6" value="3" id="q6_3"><label for="q6_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>7. صعوبة في التركيز على الأشياء، مثل قراءة الجريدة أو مشاهدة التلفزيون</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q7" value="0" id="q7_0" required><label for="q7_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q7" value="1" id="q7_1"><label for="q7_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q7" value="2" id="q7_2"><label for="q7_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q7" value="3" id="q7_3"><label for="q7_3">كل يوم تقريباً</label></div>
                </div>
            </div>
            
            <div class="question">
                <p>8. التحرك أو التحدث ببطء شديد بحيث يمكن للآخرين ملاحظته؟ أو العكس - كونك مضطربًا أو قلقًا لدرجة أنك تتحرك أكثر من المعتاد</p>
                <div class="options">
                    <div class="option"><input type="radio" name="q8" value="0" id="q8_0" required><label for="q8_0">أبداً</label></div>
                    <div class="option"><input type="radio" name="q8" value="1" id="q8_1"><label for="q8_1">عدة أيام</label></div>
                    <div class="option"><input type="radio" name="q8" value="2" id="q8_2"><label for="q8_2">أكثر من نصف الأيام</label></div>
                    <div class="option"><input type="radio" name="q8" value="3" id="q8_3"><label for="q8_3">كل يوم تقريباً</label></div>
                </div>
            </div>
        </div>

        <div id="submitSection" class="section hidden">
            <button id="submitButton">إرسال الاستبيان</button>
            <div id="message"></div>
        </div>

        <button id="nextButton" disabled>التالي</button>
    </div>

    <script>
        // عناصر DOM
        const consentCheckbox = document.getElementById('consentCheckbox');
        const nextButton = document.getElementById('nextButton');
        const consentSection = document.getElementById('consentSection');
        const demographicsSection = document.getElementById('demographicsSection');
        const recordingSection = document.getElementById('recordingSection');
        const phq8Section = document.getElementById('phq8Section');
        const submitSection = document.getElementById('submitSection');
        const recordButton = document.getElementById('recordButton');
        const timer = document.getElementById('timer');
        const audioPlayback = document.getElementById('audioPlayback');
        const submitButton = document.getElementById('submitButton');
        const messageDiv = document.getElementById('message');
        
        // حالة التطبيق
        let currentSection = 0;
        let mediaRecorder;
        let audioChunks = [];
        let recording = false;
        let recordingTime = 0;
        let timerInterval;
        let audioBlob;
        
        // الانتقال بين الأقسام
        nextButton.addEventListener('click', () => {
            const sections = [consentSection, demographicsSection, recordingSection, phq8Section, submitSection];
            
            // إخفاء القسم الحالي
            sections[currentSection].classList.add('hidden');
            
            // الانتقال إلى القسم التالي
            currentSection++;
            
            // إظهار القسم الجديد
            sections[currentSection].classList.remove('hidden');
            
            // تحديث نص زر التالي أو إخفاؤه
            if (currentSection === sections.length - 1) {
                nextButton.classList.add('hidden');
            } else {
                nextButton.textContent = currentSection === sections.length - 2 ? 'انهاء' : 'التالي';
            }
            
            // تعطيل زر التالي حتى يكمل المستخدم الإجراءات المطلوبة
            nextButton.disabled = true;
            
            // إذا كان القسم الحالي هو قسم التسجيل، تهيئة التسجيل
            if (currentSection === 2) {
                initRecording();
            }
        });
        
        // تمكين الزر التالي عند الموافقة
        consentCheckbox.addEventListener('change', () => {
            nextButton.disabled = !consentCheckbox.checked;
        });
        
        // التحقق من اكتمال المعلومات الديموغرافية
        document.getElementById('age').addEventListener('input', checkDemographics);
        document.getElementById('gender').addEventListener('change', checkDemographics);
        
        function checkDemographics() {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            nextButton.disabled = !(age && gender);
        }
        
        // تهيئة التسجيل الصوتي
        function initRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                messageDiv.textContent = 'المتصفح الخاص بك لا يدعم التسجيل الصوتي. يرجى استخدام متصفح حديث مثل Chrome أو Firefox.';
                messageDiv.className = 'error';
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPlayback.src = audioUrl;
                        audioPlayback.classList.remove('hidden');
                        nextButton.disabled = false;
                    };
                })
                .catch(err => {
                    console.error('Error accessing microphone:', err);
                    messageDiv.textContent = 'خطأ في الوصول إلى الميكروفون. يرجى التحقق من الأذونات.';
                    messageDiv.className = 'error';
                });
        }
        
        // التحكم في التسجيل
        recordButton.addEventListener('click', () => {
            if (!recording) {
                // بدء التسجيل
                audioChunks = [];
                mediaRecorder.start();
                recording = true;
                recordButton.textContent = 'إيقاف التسجيل';
                recordButton.classList.add('recording');
                
                // بدء العد التنازلي
                recordingTime = 0;
                timerInterval = setInterval(() => {
                    recordingTime++;
                    const minutes = Math.floor(recordingTime / 60).toString().padStart(2, '0');
                    const seconds = (recordingTime % 60).toString().padStart(2, '0');
                    timer.textContent = `${minutes}:${seconds}`;
                    
                    // إيقاف التسجيل تلقائياً بعد 5 دقائق (300 ثانية)
                    if (recordingTime >= 300) {
                        stopRecording();
                    }
                }, 1000);
            } else {
                stopRecording();
            }
        });
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            recording = false;
            recordButton.textContent = 'بدء التسجيل';
            recordButton.classList.remove('recording');
            clearInterval(timerInterval);
        }
        
        // التحقق من اكتمال استبيان PHQ-8
        const phqQuestions = document.querySelectorAll('input[type="radio"]');
        phqQuestions.forEach(question => {
            question.addEventListener('change', checkPHQ8Completion);
        });
        
        function checkPHQ8Completion() {
            let allAnswered = true;
            for (let i = 1; i <= 8; i++) {
                const answered = document.querySelector(`input[name="q${i}"]:checked`);
                if (!answered) {
                    allAnswered = false;
                    break;
                }
            }
            nextButton.disabled = !allAnswered;
        }
        
        // إرسال البيانات
        submitButton.addEventListener('click', async () => {
            submitButton.disabled = true;
            messageDiv.textContent = 'جاري إرسال البيانات...';
            messageDiv.className = '';
            
            try {
                // جمع بيانات PHQ-8
                let phq8Score = 0;
                const phq8Answers = [];
                for (let i = 1; i <= 8; i++) {
                    const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
                    phq8Answers.push(answer);
                    phq8Score += parseInt(answer);
                }
                
                // جمع البيانات الديموغرافية
                const age = document.getElementById('age').value;
                const gender = document.getElementById('gender').value;
                
                // إنشاء FormData لإرسال البيانات
                const formData = new FormData();
                formData.append('age', age);
                formData.append('gender', gender);
                formData.append('phq8Score', phq8Score);
                formData.append('phq8Answers', JSON.stringify(phq8Answers));
                
                if (audioBlob) {
                    formData.append('audio', audioBlob, 'recording.webm');
                }
                
                // إرسال البيانات إلى Google Apps Script
                const response = await fetch('https://script.google.com/macros/s/AKfycbxQaHbu56Ok4PUrc9wtdK3gDCC_PVAsY5yObrlb_LvG44_C2MNX1hkLgD0cppJ8kXSz/exec', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    messageDiv.textContent = 'تم إرسال الاستبيان بنجاح! شكراً لمشاركتك.';
                    messageDiv.className = 'success';
                    submitButton.classList.add('hidden');
                } else {
                    throw new Error(result.error || 'فشل في إرسال البيانات');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                messageDiv.textContent = 'حدث خطأ أثناء إرسال البيانات. يرجى المحاولة مرة أخرى.';
                messageDiv.className = 'error';
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>
