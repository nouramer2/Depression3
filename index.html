<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>استبيان الاكتئاب</title>
  <style>
    /* نفس الستايل السابق */
    body {
      font-family: "Tahoma", sans-serif;
      background: #f4f6f9;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    /* ... باقي الستايل كما هو ... */
  </style>
</head>
<body>

  <h1>📝 استبيان الاكتئاب (PHQ-9)</h1>

  <form id="surveyForm">
    <label>العمر:</label>
    <input type="number" id="age" name="age" required min="18" max="100">

    <label>النوع:</label>
    <select id="gender" name="gender" required>
      <option value="">اختر</option>
      <option value="male">ذكر</option>
      <option value="female">أنثى</option>
      <option value="other">آخر</option>
    </select>

    <!-- أسئلة PHQ-9 -->
    <div id="questions"></div>

    <!-- تسجيل الصوت -->
    <h2>🎤 التسجيل الصوتي</h2>
    <button type="button" id="recordBtn">ابدأ التسجيل</button>
    <button type="button" id="stopBtn" disabled>إيقاف التسجيل</button>
    <p id="recordStatus">لم يبدأ التسجيل بعد</p>
    
    <!-- شريط التقدم -->
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
    <div id="fileInfo" class="file-info"></div>

    <button type="submit" id="submitBtn">إرسال الاستبيان</button>
  </form>

  <script>
    const questionsText = [
      "قلة الاهتمام أو المتعة بالقيام بالأشياء",
      "الشعور بالإحباط أو الاكتئاب أو اليأس",
      "صعوبة النوس أو النوم لفترات طويلة",
      "الشعور بالتعب أو فقدان الطاقة",
      "ضعف الشهية أو الإفراط في الأكل",
      "الشعور السيء تجاه نفسك أو أنك فاشل",
      "صعوبة التركيز في الأنشطة اليومية",
      "الحركة أو الكلام ببطء شديد أو بسرعة مفرطة",
      "أفكار عن الموت أو إيذاء النفس"
    ];

    const questionsDiv = document.getElementById("questions");
    questionsText.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="q${i}" value="0" required> أبداً</label>
        <label><input type="radio" name="q${i}" value="1"> عدة أيام</label>
        <label><input type="radio" name="q${i}" value="2"> أكثر من نصف الأيام</label>
        <label><input type="radio" name="q${i}" value="3"> تقريباً كل يوم</label>
      `;
      questionsDiv.appendChild(div);
    });

    // تسجيل الصوت
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let recordingStartTime;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordStatus = document.getElementById("recordStatus");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const fileInfo = document.getElementById("fileInfo");
    const submitBtn = document.getElementById("submitBtn");

    recordBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true
          } 
        });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recordingStartTime = Date.now();

        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const duration = Math.round((Date.now() - recordingStartTime) / 1000);
          const sizeMB = (audioBlob.size / (1024 * 1024)).toFixed(2);
          
          recordStatus.textContent = `✅ تم تسجيل ${duration} ثانية (${sizeMB} MB)`;
          fileInfo.textContent = `حجم الملف: ${sizeMB} MB - المدة: ${duration} ثانية`;
          
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordStatus.textContent = "🔴 جاري التسجيل...";
        recordBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (error) {
        console.error("خطأ في الوصول إلى الميكروفون:", error);
        recordStatus.textContent = "❌ خطأ في الوصول إلى الميكروفون";
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordStatus.textContent = "⏹️ تم إيقاف التسجيل، جاهز للإرسال";
      }
    });

    // إرسال البيانات - الإصدار المعدل
    document.getElementById("surveyForm").addEventListener("submit", function(e) {
      e.preventDefault();

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = "جاري الإرسال...";
        progressBar.style.display = 'block';

        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;

        const phqAnswers = [];
        for (let i = 0; i < 9; i++) {
          const answer = document.querySelector(`input[name="q${i}"]:checked`).value;
          phqAnswers.push(parseInt(answer));
        }

        const totalScore = phqAnswers.reduce((a, b) => a + b, 0);

        const formData = new FormData();
        formData.append("age", age);
        formData.append("gender", gender);
        formData.append("totalScore", totalScore);
        formData.append("phqAnswers", JSON.stringify(phqAnswers));
        formData.append("timestamp", new Date().toISOString());

        if (audioBlob) {
          formData.append("audioFile", audioBlob, `recording_${Date.now()}.webm`);
        }

        const xhr = new XMLHttpRequest();
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzjXdSNqX-2qNweLuDb2yE93X5HFTXvBH4jLmKCrMFoWjtBVx5SpNp4HJIpx97A3MzY/exec';
        
        xhr.open('POST', scriptURL);
        xhr.responseType = 'json';

        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
            fileInfo.textContent = `جاري الرفع: ${percentComplete.toFixed(1)}%`;
          }
        });

        xhr.onload = function() {
          progressBar.style.display = 'none';
          
          if (xhr.status === 200) {
            const response = xhr.response;
            if (response && response.status === "success") {
              alert("✅ تم إرسال الاستبيان بنجاح!");
              document.getElementById("surveyForm").reset();
              audioBlob = null;
              fileInfo.textContent = "";
            } else {
              alert("❌ " + (response?.message || "حدث خطأ غير متوقع"));
            }
          } else {
            alert("❌ خطأ في الخادم: " + xhr.status);
          }
          
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الاستبيان";
        };

        xhr.onerror = function() {
          progressBar.style.display = 'none';
          alert("❌ فشل الاتصال بالخادم. تأكد من اتصال الإنترنت وحاول مرة أخرى.");
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الاستبيان";
        };

        xhr.ontimeout = function() {
          progressBar.style.display = 'none';
          alert("⏰ انتهت مهلة الاتصال. حاول مرة أخرى.");
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الاستبيان";
        };

        // إضافة timeout لمدة 5 دقائق
        xhr.timeout = 300000;
        
        xhr.send(formData);

      } catch (error) {
        console.error("خطأ في الإرسال:", error);
        alert("❌ حدث خطأ: " + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "إرسال الاستبيان";
        progressBar.style.display = 'none';
      }
    });

    // التحقق من دعم التسجيل الصوتي
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      recordStatus.textContent = "❌ المتصفح لا يدعم التسجيل الصوتي";
      recordBtn.disabled = true;
    }
  </script>
</body>
</html>

